#!/bin/bash

LOG_FILE="/home/user/MX_LEBD_Handling.log"
TEMP_DIR="/home/user/temp"

# 创建临时目录
mkdir -p "$TEMP_DIR"

# 清空日志文件
> "$LOG_FILE"

# 检查文件是否只有一行
check_single_line() {
    local file="$1"
    local line_count=$(cat "$file" | wc -l)

    if [[ $line_count -eq 1 ]]; then
        echo "File $file contains exactly one line." >> "$LOG_FILE"
        return 0
    else
        echo "File $file does not contain exactly one line." >> "$LOG_FILE"
        return 1
    fi
}

# 检查两个文件的内容是否相同
check_content_match() {
    local file1="$1"
    local file2="$2"
    local diff_output=$(diff <(cat "$file1") <(cat "$file2"))

    if [[ -z "$diff_output" ]]; then
        echo "Content of both files $file1 and $file2 is identical." >> "$LOG_FILE"
        return 0
    else
        echo "Content of files $file1 and $file2 is different." >> "$LOG_FILE"
        return 1
    fi
}

# 复制文件到临时目录
backup_files() {
    local files=("$@")
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local backup_dir="$TEMP_DIR/backup_$timestamp"
    
    # 创建临时目录中的备份目录
    mkdir -p "$backup_dir"
    
    # 复制文件到备份目录
    for file in "${files[@]}"; do
        cp "$file" "$backup_dir"
        echo "Copied $file to $backup_dir" >> "$LOG_FILE"
    done
}

# 删除文件中的第一行
delete_line() {
    local file="$1"
    local temp_file="${file}.tmp"
    echo "Deleting first line from $file..."
    # 使用 sed 保存到临时文件
    sed '1d' "$file" > "$temp_file"
    if [ $? -eq 0 ]; then
        # 移动临时文件并删除原文件
        mv "$temp_file" "$file"
        echo "Deleted first line from $file... Done" >> "$LOG_FILE"
    else
        echo "Failed to delete first line from $file" >> "$LOG_FILE"
    fi
}

# 检查指定目录下是否有且仅有一个符合模式的文件
check_and_move_file() {
    local source_dir="$1"
    local target_dir="$2"
    local files=$(ls "$source_dir" | grep -E 'GLE.IN.HUBMX.PRD01.LEBD.*')
    local count=$(echo "$files" | wc -w)

    if [[ $count -eq 1 ]]; then
        mv "$source_dir/$files" "$target_dir"
        echo "Moved file $files to $target_dir" >> "$LOG_FILE"
        return 0
    else
        echo "Found $count files matching pattern, expected exactly one." >> "$LOG_FILE"
        return 1
    fi
}

# 文件路径
file1="/controlM/logs/FileACK_BatchID_Log.txt"
file2="/controlM/logs/RecACK_BatchID_Lo.gtxt"
source_dir="/MX_D/MX_L/"
target_dir="/genF/acc/"

# 检查文件是否只有一行
if check_single_line "$file1" && check_single_line "$file2"; then
    # 检查两个文件的内容是否相同
    if check_content_match "$file1" "$file2"; then
        # 备份文件
        backup_files "$file1" "$file2" "$source_dir/GLE.IN.HUBMX.PRD01.LEBD*"
        
        # 删除文件中的一行
        delete_line "$file1"
        delete_line "$file2"
        
        # 检查并移动文件
        if check_and_move_file "$source_dir" "$target_dir"; then
            echo "Script completed successfully." >> "$LOG_FILE"
        else
            echo "Failed to move the file." >> "$LOG_FILE"
        fi
    else
        echo "Failed to verify the content of the files." >> "$LOG_FILE"
    fi
else
    echo "Failed to verify the number of lines in the files." >> "$LOG_FILE"
fi
